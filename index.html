<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“ Journal de Classe</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
        }
        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
        header {
            background: white;
            padding: 40px;
            margin-bottom: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            text-align: center;
        }
        h1 { font-size: 2.5em; margin-bottom: 10px; color: #667eea; }
        h1::before { content: 'ğŸ“š '; }
        .subtitle { color: #666; font-style: italic; font-size: 1.1em; }
        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 10px;
            color: white;
            flex-wrap: wrap;
            gap: 10px;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
        button.logout { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        button.admin-btn { background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%); }
        button.delete { background: linear-gradient(135deg, #ff6b6b 0%, #c92a2a 100%); padding: 8px 15px; font-size: 14px; }
        button.edit { background: linear-gradient(135deg, #4ecdc4 0%, #44a3a0 100%); padding: 8px 15px; font-size: 14px; }
        button.small { padding: 8px 20px; font-size: 14px; }
        .section {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }
        h2 { color: #667eea; margin-bottom: 20px; font-size: 1.8em; }
        h3 { color: #764ba2; margin: 25px 0 15px 0; font-size: 1.4em; }
        label { display: block; margin: 15px 0 5px 0; font-weight: 600; color: #555; }
        input, textarea, select {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 15px;
            font-family: inherit;
        }
        input:focus, textarea:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        textarea { min-height: 250px; resize: vertical; }
        .hidden { display: none; }
        .error, .success, .info, .warning {
            margin: 15px 0;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid;
        }
        .error { color: #e53e3e; background: #fff5f5; border-color: #e53e3e; }
        .success { color: #38a169; background: #f0fff4; border-color: #38a169; }
        .info { color: #3182ce; background: #ebf8ff; border-color: #3182ce; }
        .warning { color: #d69e2e; background: #fffaf0; border-color: #d69e2e; }
        .user-card {
            background: #f8f9fa;
            padding: 20px;
            margin: 15px 0;
            border-radius: 15px;
            border: 2px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .user-card.admin-user { background: linear-gradient(135deg, #fff9e6 0%, #ffe9b3 100%); border-color: #ffd89b; }
        .user-info-text { flex: 1; min-width: 200px; }
        .user-actions { display: flex; gap: 10px; flex-wrap: wrap; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }
        .stat-number { font-size: 2.5em; font-weight: bold; margin: 10px 0; }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }
        .modal-content {
            background: white;
            margin: 10% auto;
            padding: 40px;
            border-radius: 20px;
            max-width: 500px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .modal-buttons { display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end; }
        @media (max-width: 600px) {
            .container { padding: 10px; }
            .section { padding: 25px; }
            h1 { font-size: 1.8em; }
            button { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Journal de Classe</h1>
            <p class="subtitle">Partagez vos idÃ©es et dÃ©couvertes ! ğŸš€</p>
            <div id="userInfo" class="user-info hidden">
                <span>ğŸ‘¤ <strong id="currentUser"></strong></span>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="small" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);" onclick="showChangePassword()">ğŸ” Mon mot de passe</button>
                    <button id="adminBtn" class="admin-btn small hidden" onclick="toggleAdmin()">ğŸ‘‘ Admin</button>
                    <button class="logout" onclick="logout()">ğŸšª DÃ©connexion</button>
                </div>
            </div>
        </header>

        <div id="configSection" class="section">
            <h2>âš™ï¸ Configuration</h2>
            <label>ğŸ”— URL Supabase:</label>
            <input type="text" id="supabaseUrl" value="https://xnbhtnrnngghumegyyzr.supabase.co">
            <label>ğŸ”‘ ClÃ© Supabase:</label>
            <input type="text" id="supabaseKey" value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhuYmh0bnJubmdnaHVtZWd5eXpyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4NDUyNTIsImV4cCI6MjA4MDQyMTI1Mn0.Z0A3dFJ38SNT3wwJxbfqMcEKXJbGdwoGSMYfkAk_9i8">
            <button onclick="saveConfig()">ğŸ’¾ Continuer</button>
            <div id="configMsg"></div>
        </div>

        <div id="loginSection" class="section hidden">
            <h2>ğŸ” Connexion</h2>
            <label>ğŸ‘¤ Nom d'utilisateur:</label>
            <input type="text" id="username">
            <label>ğŸ”’ Mot de passe:</label>
            <input type="password" id="password">
            <div id="loginError" class="error hidden"></div>
            <button onclick="login()">ğŸš€ Se connecter</button>
        </div>

        <div id="changePasswordSection" class="section hidden">
            <h2>ğŸ” Changer mon mot de passe</h2>
            <p class="info">âš ï¸ Attention : une fois changÃ©, utilisez toujours le nouveau mot de passe !</p>
            <label>ğŸ”’ Mot de passe actuel:</label>
            <input type="password" id="currentPwd">
            <label>ğŸ†• Nouveau mot de passe:</label>
            <input type="password" id="newPwd">
            <label>âœ… Confirmer:</label>
            <input type="password" id="confirmPwd">
            <div id="changePwdMsg"></div>
            <div style="display: flex; gap: 10px;">
                <button onclick="changePassword()">ğŸ’¾ Changer</button>
                <button class="logout" onclick="hideChangePassword()">âŒ Annuler</button>
            </div>
        </div>

        <div id="adminSection" class="section hidden">
            <h2>ğŸ‘‘ Panel Admin</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div>ğŸ‘¥ Utilisateurs</div>
                    <div class="stat-number" id="userCount">0</div>
                </div>
            </div>
            <h3>â• Ajouter un utilisateur</h3>
            <label>ğŸ‘¤ Nom (ex: PaulMartin):</label>
            <input type="text" id="addUsername">
            <label>ğŸ”’ Mot de passe:</label>
            <input type="password" id="addPassword">
            <button onclick="addUser()">â• CrÃ©er</button>
            <div id="addMsg"></div>
            <h3>ğŸ‘¥ Liste des utilisateurs</h3>
            <div id="usersList"></div>
        </div>

        <div id="articleSection" class="section hidden">
            <h2>âœï¸ CrÃ©er un article</h2>
            <label>ğŸ‘¤ Auteur:</label>
            <input type="text" id="author">
            <label>ğŸ“Œ Titre:</label>
            <input type="text" id="title">
            <label>ğŸ“ Contenu:</label>
            <textarea id="content" placeholder="Ã‰crivez votre article..."></textarea>
            <label>ğŸ“… Date:</label>
            <input type="date" id="date">
            <div id="articleMsg"></div>
            <button onclick="createArticle()">ğŸš€ Publier</button>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <h2>âœï¸ Modifier le mot de passe</h2>
            <label>ğŸ‘¤ Utilisateur:</label>
            <input type="text" id="editUser" disabled style="background: #f0f0f0;">
            <label>ğŸ”’ Nouveau mot de passe:</label>
            <input type="password" id="editPwd">
            <div id="editMsg"></div>
            <div class="modal-buttons">
                <button class="logout" onclick="closeEdit()">Annuler</button>
                <button onclick="saveEdit()">ğŸ’¾ Sauvegarder</button>
            </div>
        </div>
    </div>

    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <h2 id="confirmTitle">â“ Confirmation</h2>
            <p id="confirmMsg"></p>
            <div class="modal-buttons">
                <button class="logout" onclick="closeConfirm()">Annuler</button>
                <button class="delete" onclick="doDelete()">ğŸ—‘ï¸ Supprimer</button>
            </div>
        </div>
    </div>

    <script>
        let supabase, currentUsername, users = {}, editingUser, deleteUser;
        const ADMIN_PWD = '5121';

        function loadUsers() {
            const stored = localStorage.getItem('journalUsers');
            if (stored) users = JSON.parse(stored);
            else users = {"admin":"admin2024","SonjayMENAGER":"sonjay123","EthanDROUANT":"ethan123","AxelVOISINE":"axel123","MaximeDEFFOIS":"maxime123","HediMONTGOBERT":"hedi123","BixenteNGUYEN":"bixente123","OscarLAIRE":"oscar123","NathysOGERCOLAS":"nathys123","MathÃ©oPAULBEAUVAIS":"matheo123","GabinMARAIS":"gabin123","MeyssonGUERIN":"meysson123","PaulLIMOUSIN":"paul123","AurÃ©lienNANTA":"aurelien123","FanchSCALLIT":"fanch123","PaulSOLEAU":"paulsoleau123"};
        }

        function saveUsers() {
            localStorage.setItem('journalUsers', JSON.stringify(users));
        }

        function show(id) { document.getElementById(id).classList.remove('hidden'); }
        function hide(id) { document.getElementById(id).classList.add('hidden'); }

        function showMsg(id, txt, cls, hideAfter = true) {
            const el = document.getElementById(id);
            el.textContent = txt;
            el.className = cls || '';
            if (!cls) el.classList.remove('hidden');
            if (hideAfter) setTimeout(() => el.textContent = '', 3000);
        }

        async function saveConfig() {
            const url = document.getElementById('supabaseUrl').value.trim();
            const key = document.getElementById('supabaseKey').value.trim();
            if (!url || !key) {
                showMsg('configMsg', 'âŒ Remplissez tous les champs', 'error');
                return;
            }
            try {
                supabase = window.supabase.createClient(url, key);
                localStorage.setItem('blogConfig', JSON.stringify({url, key}));
                loadUsers();
                saveUsers();
                showMsg('configMsg', 'âœ… Configuration OK !', 'success');
                setTimeout(() => {
                    hide('configSection');
                    show('loginSection');
                }, 1000);
            } catch(e) {
                showMsg('configMsg', 'âŒ Erreur: ' + e.message, 'error');
            }
        }

        async function login() {
            const u = document.getElementById('username').value.trim();
            const p = document.getElementById('password').value;
            if (!u || !p) {
                showMsg('loginError', 'âŒ Remplissez tous les champs', null, false);
                return;
            }
            if (users[u] === p) {
                currentUsername = u;
                document.getElementById('currentUser').textContent = u + (u === 'admin' ? ' ğŸ‘‘' : '');
                document.getElementById('author').value = u;
                hide('loginSection');
                show('userInfo');
                show('articleSection');
                if (u === 'admin') show('adminBtn');
            } else {
                showMsg('loginError', 'âŒ Identifiants incorrects', null, false);
            }
        }

        function logout() {
            currentUsername = null;
            hide('userInfo');
            hide('adminBtn');
            hide('articleSection');
            hide('adminSection');
            hide('changePasswordSection');
            show('loginSection');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        function toggleAdmin() {
            if (currentUsername !== 'admin') return;
            const pwd = prompt('ğŸ” Mot de passe admin:');
            if (pwd !== ADMIN_PWD) {
                alert('âŒ Mot de passe incorrect !');
                return;
            }
            if (document.getElementById('adminSection').classList.contains('hidden')) {
                hide('articleSection');
                hide('changePasswordSection');
                show('adminSection');
                displayUsers();
            } else {
                hide('adminSection');
                show('articleSection');
            }
        }

        function showChangePassword() {
            hide('articleSection');
            hide('adminSection');
            show('changePasswordSection');
            document.getElementById('currentPwd').value = '';
            document.getElementById('newPwd').value = '';
            document.getElementById('confirmPwd').value = '';
            document.getElementById('changePwdMsg').textContent = '';
        }

        function hideChangePassword() {
            hide('changePasswordSection');
            show('articleSection');
        }

        function changePassword() {
            const curr = document.getElementById('currentPwd').value;
            const newP = document.getElementById('newPwd').value;
            const conf = document.getElementById('confirmPwd').value;
            
            if (!curr || !newP || !conf) {
                showMsg('changePwdMsg', 'âŒ Remplissez tous les champs', 'error');
                return;
            }
            if (users[currentUsername] !== curr) {
                showMsg('changePwdMsg', 'âŒ Mot de passe actuel incorrect', 'error');
                return;
            }
            if (newP.length < 4) {
                showMsg('changePwdMsg', 'âŒ Le mot de passe doit faire au moins 4 caractÃ¨res', 'error');
                return;
            }
            if (newP !== conf) {
                showMsg('changePwdMsg', 'âŒ Les mots de passe ne correspondent pas', 'error');
                return;
            }
            users[currentUsername] = newP;
            saveUsers();
            showMsg('changePwdMsg', 'âœ… Mot de passe changÃ© ! Utilisez-le Ã  la prochaine connexion.', 'success');
            setTimeout(() => {
                hideChangePassword();
            }, 2000);
        }

        function displayUsers() {
            const list = document.getElementById('usersList');
            document.getElementById('userCount').textContent = Object.keys(users).length;
            list.innerHTML = Object.keys(users).map(u => `
                <div class="user-card ${u === 'admin' ? 'admin-user' : ''}">
                    <div class="user-info-text">
                        <strong>${u}</strong> ${u === 'admin' ? 'ğŸ‘‘' : ''}
                        <small>Mot de passe: ${users[u].replace(/./g, 'â€¢')}</small>
                    </div>
                    <div class="user-actions">
                        <button class="edit" onclick="editUser('${u}')">âœï¸ Modifier</button>
                        ${u !== 'admin' ? `<button class="delete" onclick="confirmDelete('${u}')">ğŸ—‘ï¸ Supprimer</button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function addUser() {
            const u = document.getElementById('addUsername').value.trim();
            const p = document.getElementById('addPassword').value;
            if (!u || !p) {
                showMsg('addMsg', 'âŒ Remplissez tous les champs', 'error');
                return;
            }
            if (users[u]) {
                showMsg('addMsg', 'âŒ Cet utilisateur existe dÃ©jÃ ', 'error');
                return;
            }
            if (p.length < 4) {
                showMsg('addMsg', 'âŒ Le mot de passe doit faire au moins 4 caractÃ¨res', 'error');
                return;
            }
            users[u] = p;
            saveUsers();
            showMsg('addMsg', `âœ… ${u} a Ã©tÃ© crÃ©Ã© !`, 'success');
            document.getElementById('addUsername').value = '';
            document.getElementById('addPassword').value = '';
            displayUsers();
        }

        function editUser(u) {
            editingUser = u;
            document.getElementById('editUser').value = u;
            document.getElementById('editPwd').value = '';
            document.getElementById('editMsg').textContent = '';
            document.getElementById('editModal').style.display = 'block';
        }

        function closeEdit() {
            document.getElementById('editModal').style.display = 'none';
            editingUser = null;
        }

        function saveEdit() {
            const p = document.getElementById('editPwd').value;
            if (!p) {
                showMsg('editMsg', 'âŒ Entrez un mot de passe', 'error');
                return;
            }
            if (p.length < 4) {
                showMsg('editMsg', 'âŒ Au moins 4 caractÃ¨res', 'error');
                return;
            }
            users[editingUser] = p;
            saveUsers();
            showMsg('editMsg', 'âœ… Mot de passe modifiÃ© !', 'success');
            setTimeout(() => {
                closeEdit();
                displayUsers();
            }, 1000);
        }

        function confirmDelete(u) {
            deleteUser = u;
            document.getElementById('confirmMsg').textContent = `Supprimer ${u} ? Cette action est irrÃ©versible.`;
            document.getElementById('confirmModal').style.display = 'block';
        }

        function closeConfirm() {
            document.getElementById('confirmModal').style.display = 'none';
            deleteUser = null;
        }

        function doDelete() {
            if (deleteUser && deleteUser !== 'admin') {
                delete users[deleteUser];
                saveUsers();
                displayUsers();
            }
            closeConfirm();
        }

        async function createArticle() {
            const a = document.getElementById('author').value.trim();
            const t = document.getElementById('title').value.trim();
            const c = document.getElementById('content').value.trim();
            const d = document.getElementById('date').value;
            if (!a || !t || !c || !d) {
                showMsg('articleMsg', 'âŒ Remplissez tous les champs', 'error');
                return;
            }
            try {
                await supabase.from('articles').insert([{author: a, title: t, content: c, date: d, created_by: currentUsername}]);
                showMsg('articleMsg', 'âœ… Article publiÃ© ! ğŸ‰', 'success');
                document.getElementById('title').value = '';
                document.getElementById('content').value = '';
            } catch(e) {
                showMsg('articleMsg', 'âŒ Erreur: ' + e.message, 'error');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('date').valueAsDate = new Date();
            const cfg = localStorage.getItem('blogConfig');
            if (cfg) {
                const {url, key} = JSON.parse(cfg);
                document.getElementById('supabaseUrl').value = url;
                document.getElementById('supabaseKey').value = key;
                supabase = window.supabase.createClient(url, key);
                loadUsers();
                hide('configSection');
                show('loginSection');
            }
        });
    </script>
</body>
</html>
